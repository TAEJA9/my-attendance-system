<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>실시간 출석 체크 시스템</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- QR 코드 라이브러리 추가 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- Font Awesome 아이콘 라이브러리 추가 (더 많은 아이콘 사용 가능) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f8f9fa;
        }
        .attendance-card {
            transition: all 0.3s ease;
        }
        .attendance-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 4px, 6px, 0.05);
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .shake {
            animation: shake 0.5s ease-in-out;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }
        .spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 3px solid #10b981;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        .refresh-spin {
            animation: spin 0.5s ease-in-out; /* 새로고침 스핀 애니메이션 */
        }
        /* Custom Modal Styling */
        .modal {
            display: none; /* 기본적으로 숨겨져 있음 */
            position: fixed; /* 화면에 고정 */
            z-index: 100; /* 다른 요소 위에 표시 */
            left: 0;
            top: 0;
            width: 100%; /* 전체 너비 */
            height: 100%; /* 전체 높이 */
            overflow: auto; /* 내용이 넘치면 스크롤 가능 */
            background-color: rgba(0,0,0,0.5); /* 반투명 검은색 배경 */
            justify-content: center; /* 가로 중앙 정렬 */
            align-items: center; /* 세로 중앙 정렬 */
        }
        .modal-content {
            background-color: #fefefe; /* 흰색 배경 */
            padding: 20px;
            border-radius: 8px; /* 둥근 모서리 */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* 그림자 */
            width: 90%;
            max-width: 400px; /* 최대 너비 제한 */
            text-align: center; /* 모달 내용 가운데 정렬 */
            position: relative; /* 닫기 버튼 배치를 위함 */
        }
        .modal-buttons {
            display: flex;
            justify-content: flex-end; /* 버튼을 오른쪽으로 정렬 */
            gap: 12px; /* 버튼 간격 */
            margin-top: 20px;
        }
        .delete-btn {
            background-color: #ef4444; /* red-500 */
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.875rem; /* text-sm */
            transition: background-color 0.2s;
        }
        .delete-btn:hover {
            background-color: #dc2626; /* red-600 */
        }
        /* 모달 닫기 버튼 */
        .modal-close-btn { /* QR 코드 모달과 다른 모달에 공통 적용 */
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 24px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            line-height: 1;
        }
        .modal-close-btn:hover,
        .modal-close-btn:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
        /* 텍스트 에어리어 높이 */
        textarea {
            min-height: 150px;
        }
        /* 버튼 텍스트 숨기기 - 모바일에서 */
        .button-text {
            display: none; /* 기본적으로 텍스트 숨기기 */
        }
        /* 작은 화면(sm) 이상에서 텍스트 보이기 */
        @media (min-width: 640px) { /* Tailwind의 sm breakpoint */
            .button-text {
                display: inline;
            }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <div class="container mx-auto px-4 py-8 max-w-4xl flex-grow">
        <!-- Header Section -->
        <header class="mb-8 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-green-700 mb-2">실시간 출석 체크 시스템</h1>
            <p class="text-gray-600">이름을 입력하고 출석하기를 눌러주세요!</p>
            <!-- Displays the current user's ID - Hidden as requested -->
            <p id="currentUserId" class="text-gray-500 text-xs mt-2 hidden"></p>
        </header>

        <!-- Attendance Form Section -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <form id="attendanceForm" class="space-y-4">
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700 mb-1">이름</label>
                    <input type="text" id="name" name="name" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                        placeholder="이름을 입력하세요">
                </div>
                <button type="submit" id="submitBtn" 
                    class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-colors">
                    출석하기
                </button>
                <!-- Warning/Success messages inside the form -->
                <div id="formAlert" class="hidden mt-3 p-3 rounded-md text-center text-sm"></div>
            </form>
        </div>

        <!-- Attendance List Section -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center">
                    <h2 class="text-xl font-semibold text-gray-800">출석 현황</h2><!-- Text changed: 출석 목록 -> 출석 현황 -->
                    <div class="ml-2 bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded-full flex items-center">
                        <span class="w-2 h-2 bg-green-500 rounded-full mr-1 pulse"></span>
                        <span class="button-text">실시간</span> <!-- '실시간' 글자를 모바일에서 숨김 -->
                    </div>
                </div>
                <!-- 버튼들을 묶는 div에 flex-wrap 추가 및 items-center 제거 -->
                <div class="flex flex-wrap justify-end gap-2 sm:gap-3 items-center">
                    <!-- 현재 업데이트 시간은 유지 -->
                    <div class="text-xs text-gray-500 w-full sm:w-auto text-right mb-2 sm:mb-0">
                        최근 업데이트: <span id="lastUpdateTime">-</span>
                    </div>
                    <!-- 총 인원 수도 유지 -->
                    <span id="totalCount" class="bg-green-100 text-green-800 text-sm font-medium px-2.5 py-0.5 rounded-full mb-2 sm:mb-0">
                        총 0명
                    </span>
                    
                    <!-- 버튼 그룹 (작은 화면에서는 텍스트 숨기고 아이콘만, 큰 화면에서 텍스트 보이기) -->
                    <button id="refreshBtn" class="flex-shrink-0 text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 p-1.5 rounded-full transition-colors flex items-center justify-center" title="새로고침">
                        <i class="fas fa-sync-alt text-lg"></i> <!-- 새로고침 아이콘 -->
                        <span class="button-text ml-1">새로고침</span>
                    </button>
                    
                    <button id="adminBtn" class="flex-shrink-0 text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 p-1.5 rounded-full transition-colors flex items-center justify-center" title="관리자">
                        <i class="fas fa-user-shield text-lg"></i> <!-- 관리자 아이콘 -->
                        <span class="button-text ml-1">관리자</span>
                    </button>
                    
                    <button id="qrCodeBtn" class="flex-shrink-0 text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 p-1.5 rounded-full transition-colors flex items-center justify-center" title="QR 코드 생성">
                        <i class="fas fa-qrcode text-lg"></i> <!-- QR 코드 아이콘 -->
                        <span class="button-text ml-1">QR 코드</span>
                    </button>
                </div>
            </div>
            
            <!-- Loading indicator -->
            <div id="loadingIndicator" class="flex justify-center my-8 hidden">
                <div class="spinner mr-2"></div>
                <span class="text-gray-600">데이터를 불러오는 중...</span>
            </div>
            
            <!-- Attendance list items will be dynamically added here -->
            <div id="attendanceList" class="space-y-3">
                <p id="emptyMessage" class="text-center text-gray-500 py-8">아직 출석한 사람이 없습니다</p>
            </div>
        </div>

        <!-- Admin Modal (Popup) -->
        <div id="adminModal" class="modal">
            <div class="modal-content">
                <button class="modal-close-btn" id="adminModalCloseBtn">&times;</button> <!-- 닫기 버튼 추가 -->
                <h3 class="text-lg font-semibold text-gray-800 mb-4">관리자 인증</h3>
                <div id="passwordSection">
                    <p class="text-gray-600 mb-4">관리자 기능을 사용하려면 비밀번호를 입력하세요.</p>
                    <input type="password" id="adminPassword" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 mb-4"
                        placeholder="비밀번호">
                    <div class="modal-buttons">
                        <button id="cancelAdminBtn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors">
                            취소
                        </button>
                        <button id="verifyAdminBtn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">
                            확인
                        </button>
                    </div>
                </div>
                <div id="adminControlsSection" class="hidden">
                    <p class="text-gray-600 mb-4">관리자 인증이 완료되었습니다. 아래 버튼을 사용하여 출석 기록을 관리할 수 있습니다.</p>
                    <div class="flex flex-wrap justify-center gap-3 mb-4"> <!-- 버튼들을 중앙 정렬하고 간격 추가 -->
                        <button id="manageRosterBtn" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors flex-grow sm:flex-grow-0">
                            명단 관리
                        </button>
                        <button id="resetAttendanceBtn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors flex-grow sm:flex-grow-0">
                            모든 출석 기록 초기화
                        </button>
                        <!-- NEW: CSV 다운로드 버튼 추가 -->
                        <button id="exportCsvBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors flex-grow sm:flex-grow-0">
                            <i class="fas fa-file-csv mr-2"></i> 명단 CSV 다운로드
                        </button>
                    </div>
                    <div class="flex justify-center"> <!-- '닫기' 버튼만 중앙 정렬 -->
                        <button id="closeAdminBtn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors w-full sm:w-auto">
                            닫기
                        </button>
                    </div>
                </div>
                <!-- Alert message inside admin modal -->
                <div id="adminAlert" class="hidden mt-4 p-3 rounded-md text-center text-sm"></div>
            </div>
        </div>
        
        <!-- Custom Confirmation Modal (Popup) -->
        <div id="confirmationModal" class="modal">
            <div class="modal-content relative">
                <button class="modal-close-btn" id="confirmModalCloseBtn">&times;</button> <!-- 닫기 버튼 추가 -->
                <h3 class="text-lg font-semibold text-gray-800 mb-4">확인</h3>
                <p id="confirmationMessage" class="text-gray-600 mb-4"></p>
                <div class="modal-buttons">
                    <button id="confirmCancelBtn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors">
                        취소
                    </button>
                    <button id="confirmProceedBtn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors">
                        확인
                    </button>
                </div>
            </div>
        </div>

        <!-- QR Code Modal (New) -->
        <div id="qrCodeModal" class="modal">
            <div class="modal-content relative">
                <button class="modal-close-btn" id="qrModalCloseBtn">&times;</button>
                <h3 class="text-lg font-semibold text-gray-800 mb-4">출석 시스템 QR 코드</h3>
                <p class="text-gray-600 text-sm mb-4">이 QR 코드를 스캔하여 출석 시스템에 접속하세요.</p>
                <div id="qrcode" class="flex justify-center p-4 bg-white rounded-lg shadow-inner">
                    <!-- QR 코드가 여기에 생성됩니다 -->
                </div>
                <p id="qrCodeUrlDisplay" class="text-sm text-blue-600 mt-4 break-all"></p>
                <button id="copyUrlBtn" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
                    URL 복사
                </button>
            </div>
        </div>

        <!-- NEW: Roster Management Modal (명단 관리 모달) -->
        <div id="rosterModal" class="modal">
            <div class="modal-content relative">
                <button class="modal-close-btn" id="rosterModalCloseBtn">&times;</button>
                <h3 class="text-lg font-semibold text-gray-800 mb-4">명단 관리</h3>
                <p class="text-gray-600 text-sm mb-4">엑셀 등에서 이름을 복사하여 아래에 붙여넣으세요. 이름 하나당 한 줄씩 입력해야 합니다.</p>
                <textarea id="rosterInput" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 mb-4"></textarea>
                <div class="flex justify-center gap-3">
                    <button id="saveRosterBtn" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors">
                        명단 저장
                    </button>
                    <button id="viewCurrentRosterBtn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors">
                        현재 명단 확인
                    </button>
                </div>
                <div id="rosterAlert" class="hidden mt-4 p-3 rounded-md text-center text-sm"></div>
                <div id="currentRosterDisplay" class="mt-4 p-3 bg-gray-50 rounded-md text-left max-h-48 overflow-y-auto hidden">
                    <h4 class="font-semibold text-gray-700 mb-2">현재 명단:</h4>
                    <ul id="currentRosterList" class="list-disc list-inside text-gray-600">
                        <!-- 명단이 여기에 표시됩니다 -->
                    </ul>
                    <p id="emptyRosterMessage" class="text-center text-gray-500 hidden">저장된 명단이 없습니다.</p>
                </div>
            </div>
        </div>

        <!-- Status bar (displays progress or error messages) -->
        <div id="statusBar" class="fixed bottom-4 right-4 bg-white rounded-lg shadow-md p-3 hidden">
            <div class="flex items-center">
                <div id="statusIcon" class="w-3 h-3 rounded-full mr-2"></div>
                <span id="statusText" class="text-sm"></span>
            </div>
        </div>
    </div>

    <!-- Footer Section -->
    <footer class="mt-8 py-4 text-center text-gray-500 text-sm">
        <p>&copy; 2025. M.I.O Project</p>
    </footer>

    <script type="module">
        // Import Firebase SDKs from CDN
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp, runTransaction, where, getDocs, deleteDoc, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ==================================================================================
        // ★★★ 사용자님의 실제 Firebase 설정 정보를 아래에 붙여넣으세요! ★★★
        // 이 아래 'const firebaseConfig = { ... };' 블록을
        // 당신의 Firebase 콘솔에서 복사한 정확한 설정 정보로 통째로 교체하세요.
        // 예시: const firebaseConfig = { apiKey: "AIzaSy...", authDomain: "...", projectId: "...", ... };
        // ==================================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyBs1BKvEbgTDEZOozZXcpJT_2fbUapT6Zk", 
            authDomain: "jy-attendance-app.firebaseapp.com",
            projectId: "jy-attendance-app", 
            storageBucket: "jy-attendance-app.firebasestorage.app",
            messagingSenderId: "119128470991",
            appId: "1:119128470991:web:09fbd0d03fb6283b1b0eba"
        };
        // ==================================================================================
        // ★★★ 위 PLACEHOLDER 내용을 당신의 진짜 정보로 바꾸는 것이 가장 중요합니다! ★★★
        // ==================================================================================

        const initialAuthToken = null; 
        const appId = firebaseConfig.projectId;

        const ADMIN_PASSWORD = '24003';
        const ROSTER_DOC_ID = 'main_class_roster'; // 명단을 저장할 문서 ID (고정)
        
        // HTML 요소 연결
        const attendanceForm = document.getElementById('attendanceForm');
        const nameInput = document.getElementById('name');
        const submitBtn = document.getElementById('submitBtn');
        const formAlert = document.getElementById('formAlert');
        const attendanceList = document.getElementById('attendanceList');
        const emptyMessage = document.getElementById('emptyMessage');
        const totalCount = document.getElementById('totalCount');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const refreshBtn = document.getElementById('refreshBtn');
        const lastUpdateTime = document.getElementById('lastUpdateTime');
        const statusBar = document.getElementById('statusBar');
        const statusIcon = document.getElementById('statusIcon');
        const statusText = document.getElementById('statusText');
        const currentUserIdDisplay = document.getElementById('currentUserId'); 
        
        // 관리자 모달 요소
        const adminBtn = document.getElementById('adminBtn');
        const adminModal = document.getElementById('adminModal');
        const adminPassword = document.getElementById('adminPassword');
        const verifyAdminBtn = document.getElementById('verifyAdminBtn');
        const cancelAdminBtn = document.getElementById('cancelAdminBtn');
        const closeAdminBtn = document.getElementById('closeAdminBtn');
        const resetAttendanceBtn = document.getElementById('resetAttendanceBtn');
        const passwordSection = document.getElementById('passwordSection');
        const adminControlsSection = document.getElementById('adminControlsSection');
        const adminAlert = document.getElementById('adminAlert');
        const adminModalCloseBtn = document.getElementById('adminModalCloseBtn');
        const exportCsvBtn = document.getElementById('exportCsvBtn'); // NEW: CSV 다운로드 버튼

        // 확인 모달 요소
        const confirmationModal = document.getElementById('confirmationModal');
        const confirmationMessage = document.getElementById('confirmationMessage');
        const confirmCancelBtn = document.getElementById('confirmCancelBtn');
        const confirmProceedBtn = document.getElementById('confirmProceedBtn');
        const confirmModalCloseBtn = document.getElementById('confirmModalCloseBtn');

        // QR 코드 모달 요소
        const qrCodeBtn = document.getElementById('qrCodeBtn');
        const qrCodeModal = document.getElementById('qrCodeModal');
        const qrModalCloseBtn = document.getElementById('qrModalCloseBtn');
        const qrcodeContainer = document.getElementById('qrcode');
        const qrCodeUrlDisplay = document.getElementById('qrCodeUrlDisplay');
        const copyUrlBtn = document.getElementById('copyUrlBtn');

        // 명단 관리 모달 요소 (새로 추가)
        const manageRosterBtn = document.getElementById('manageRosterBtn');
        const rosterModal = document.getElementById('rosterModal');
        const rosterModalCloseBtn = document.getElementById('rosterModalCloseBtn');
        const rosterInput = document.getElementById('rosterInput');
        const saveRosterBtn = document.getElementById('saveRosterBtn');
        const viewCurrentRosterBtn = document.getElementById('viewCurrentRosterBtn');
        const rosterAlert = document.getElementById('rosterAlert');
        const currentRosterDisplay = document.getElementById('currentRosterDisplay');
        const currentRosterList = document.getElementById('currentRosterList');
        const emptyRosterMessage = document.getElementById('emptyRosterMessage');
        
        // Firebase 서비스 인스턴스 (나중에 초기화됨)
        let app;
        let db;
        let auth;
        let currentUserId = null;
        let isAuthReady = false;
        let isAdminMode = false;
        
        let attendanceData = []; // 출석 데이터
        let currentRoster = []; // 현재 명단 데이터 (배열)
        let isSubmitting = false;

        // 시스템 UI 활성화/비활성화 함수
        function setUIState(ready) {
            nameInput.disabled = !ready;
            submitBtn.disabled = !ready;
            adminBtn.disabled = !ready;
            qrCodeBtn.disabled = !ready;
            refreshBtn.disabled = !ready;

            if (ready) {
                showStatus('시스템 준비 완료!', 'success');
                // showLoading(false); // 로딩 인디케이터 숨기기
            } else {
                showStatus('시스템 준비 중...', 'info', false);
                // showLoading(true); // 로딩 인디케이터 표시
            }
        }

        // Firebase 초기화 및 사용자 인증 설정
        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // onAuthStateChanged 리스너: 인증 상태가 바뀔 때마다 호출됨
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        console.log("Firebase 인증됨. 사용자 ID:", currentUserId);
                        currentUserIdDisplay.textContent = `현재 사용자 ID: ${currentUserId}`; 
                        isAuthReady = true;
                        setUIState(true); // 인증 완료되면 UI 활성화
                        startRealtimeAttendanceListener(); // 출석 리스너 시작
                        await fetchRoster(); // 명단 불러오기
                    } else {
                        // 사용자가 로그인되어 있지 않으면 익명 로그인 시도
                        if (!isAuthReady) { // 무한 루프 방지 (이미 시도 중이면 다시 시도 안 함)
                            console.log("사용자 없음, 익명 로그인 시도...");
                            await signInAnonymously(auth);
                        }
                    }
                });

                // 페이지 로드 시 초기 인증 상태 확인 (onAuthStateChanged가 바로 호출될 수 있도록)
                if (!auth.currentUser) {
                    console.log("초기 사용자 없음. 익명 로그인 시도 중...");
                    await signInAnonymously(auth);
                }

            } catch (error) {
                console.error("Firebase 초기화 또는 인증 실패:", error);
                let errorMessage = '시스템 초기화 중 오류 발생. Firebase 설정을 확인해주세요.';
                if (error.code === 'auth/network-request-failed') {
                    errorMessage = '네트워크 연결 상태를 확인해주세요.';
                } else if (error.code === 'auth/configuration-not-found') {
                    errorMessage = 'Firebase 설정 정보가 올바르지 않습니다. Console에서 API Key 등을 확인해주세요.';
                }
                showStatus(errorMessage, 'error', false);
                setUIState(false); // 오류 발생 시 UI 비활성화
            }
        }

        // 페이지 로드 시 Firebase 초기화 시작
        document.addEventListener('DOMContentLoaded', () => {
            setUIState(false); // 모든 버튼 초기 비활성화
            initializeFirebase();
        });

        // 출석 데이터 실시간 리스너 설정
        function startRealtimeAttendanceListener() {
            if (!db || !isAuthReady) {
                console.log("Firestore 또는 인증 준비 안됨. 리스너 시작 지연.");
                return;
            }
            console.log("실시간 출석 리스너 시작.");

            const attendanceCollectionRef = collection(db, `artifacts/${appId}/public/data/attendance`);
            const q = query(attendanceCollectionRef);

            onSnapshot(q, (snapshot) => {
                let rawData = [];
                snapshot.forEach((doc) => {
                    rawData.push({ id: doc.id, ...doc.data() });
                });

                const orderedForNumbering = [...rawData].sort((a, b) => {
                    const timeA = a.timestamp && typeof a.timestamp.toDate === 'function' ? a.timestamp.toDate() : new Date(0);
                    const timeB = b.timestamp && typeof b.timestamp.toDate === 'function' ? b.timestamp.toDate() : new Date(0);
                    return timeA.getTime() - timeB.getTime(); // 가장 오래된 순 (번호 부여용)
                });

                const updatedDataWithOrder = orderedForNumbering.map((item, index) => ({
                    ...item,
                    attendanceOrder: index + 1 // 출석 순서 번호 부여
                }));

                attendanceData = [...updatedDataWithOrder].sort((a, b) => {
                    const timeA = a.timestamp && typeof a.timestamp.toDate === 'function' ? a.timestamp.toDate() : new Date(0);
                    const timeB = b.timestamp && typeof b.timestamp.toDate === 'function' ? b.timestamp.toDate() : new Date(0);
                    return timeB.getTime() - timeA.getTime(); // 최신순 (화면 표시용)
                });

                renderAttendanceList();
                updateTotalCount();
                updateLastUpdateTime();
                showStatus('출석 데이터 실시간 업데이트 완료', 'success');
            }, (error) => {
                console.error("실시간 출석 데이터 가져오기 오류:", error);
                showStatus('데이터 로드 오류', 'error');
            });
        }

        // 명단 불러오기 함수
        async function fetchRoster() {
            if (!db) {
                console.log("Firestore 준비 안됨. 명단 불러오기 지연.");
                return;
            }
            try {
                const rosterDocRef = doc(db, `artifacts/${appId}/public/data/rosters`, ROSTER_DOC_ID);
                const docSnap = await getDoc(rosterDocRef);
                if (docSnap.exists()) {
                    currentRoster = docSnap.data().names || [];
                    console.log("명단 불러오기 완료:", currentRoster);
                } else {
                    currentRoster = [];
                    console.log("저장된 명단이 없습니다.");
                }
            } catch (error) {
                console.error("명단 불러오기 오류:", error);
                showStatus('명단 불러오기 중 오류가 발생했습니다.', 'error');
            }
        }

        // 출석 폼 제출 처리
        attendanceForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = nameInput.value.trim();
            if (!name) {
                showFormAlert('이름을 입력해주세요!', 'warning');
                return;
            }
            
            console.log('출석 폼 제출', { name });
            
            if (isSubmitting || !isAuthReady) {
                if (!isAuthReady) showFormAlert('시스템 준비 중입니다. 잠시 후 다시 시도해주세요.', 'info');
                return;
            }
            
            // 명단 대조 (새로 추가된 로직)
            if (currentRoster.length > 0) {
                const normalizedName = name.toLowerCase(); // 대소문자 구분 없이 비교
                const isInRoster = currentRoster.some(rosterName => rosterName.toLowerCase() === normalizedName);
                if (!isInRoster) {
                    showFormAlert('앗, 누구세요? 이름을 정확히 입력해 주세요.', 'error');
                    nameInput.classList.add('shake');
                    setTimeout(() => nameInput.classList.remove('shake'), 500);
                    return;
                }
            }

            // 클라이언트 측 중복 체크
            const isDuplicate = attendanceData.some(item => item.name === name);
            if (isDuplicate) {
                console.log('중복 출석 시도', { name });
                showFormAlert(`앗! ${name}님은 이미 출석하셨어요.`, 'warning');
                nameInput.classList.add('shake');
                setTimeout(() => nameInput.classList.remove('shake'), 500);
                return;
            }
            
            isSubmitting = true;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<div class="spinner mx-auto"></div>';
            showStatus('출석 처리 중...', 'info', false);

            try {
                await runTransaction(db, async (transaction) => {
                    const attendanceCollectionRef = collection(db, `artifacts/${appId}/public/data/attendance`);
                    const q = query(attendanceCollectionRef, where("name", "==", name));
                    const querySnapshot = await getDocs(q);

                    if (!querySnapshot.empty) {
                        throw new Error("duplicate_attendance");
                    }

                    await addDoc(attendanceCollectionRef, {
                        name: name,
                        timestamp: serverTimestamp(), 
                        userId: currentUserId
                    });
                });

                showFormAlert(`${name}님, 출석이 완료되었습니다!`, 'success');
                showStatus('출석 완료', 'success');
                nameInput.value = '';

            } catch (error) {
                console.error("출석 추가 오류:", error);
                if (error.message === "duplicate_attendance") {
                    showFormAlert(`앗! ${name}님은 이미 출석하셨어요.`, 'warning');
                    showStatus('중복 출석 시도', 'warning');
                } else if (error.code === 'permission-denied') {
                    showFormAlert('출석 권한이 없습니다. 관리자에게 문의하세요.', 'error');
                    showStatus('출석 실패: 권한 없음', 'error');
                }
                else {
                    showFormAlert('출석 처리 중 오류가 발생했습니다.', 'error');
                    showStatus('출석 실패', 'error');
                }
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = '출석하기';
                isSubmitting = false;
                statusBar.classList.add('hidden');
            }
        });

        // 출석 목록 렌더링 (성능 개선)
        function renderAttendanceList() {
            console.log('출석 목록 렌더링 시작', { dataCount: attendanceData.length });
            
            // 모든 기존 요소를 제거하고 새로운 내용으로 채우는 방식
            attendanceList.innerHTML = ''; 
            
            if (!attendanceData || attendanceData.length === 0) {
                const p = document.createElement('p');
                p.id = 'emptyMessage'; 
                p.className = 'text-center text-gray-500 py-8';
                p.textContent = '아직 출석한 사람이 없습니다';
                attendanceList.appendChild(p);
                return;
            }
            
            attendanceData.forEach((item) => {
                const card = document.createElement('div');
                card.className = 'attendance-card bg-gray-50 rounded-lg p-4 flex justify-between items-center fade-in';
                
                let formattedDate = '날짜 정보 없음';
                let formattedTime = '시간 정보 없음';

                if (item.timestamp && typeof item.timestamp.toDate === 'function') {
                    const date = item.timestamp.toDate();
                    formattedTime = `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}:${date.getSeconds().toString().padStart(2, '0')}`;
                    formattedDate = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
                } else if (item.timestamp) {
                    try {
                        const date = new Date(item.timestamp);
                        formattedTime = `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}:${date.getSeconds().toString().padStart(2, '0')}`;
                        formattedDate = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
                    } catch (e) {
                        console.warn("Timestamp 파싱 오류:", item.timestamp, e);
                    }
                }
                
                card.innerHTML = `
                    <div class="flex items-center">
                        <div class="bg-green-100 text-green-800 h-10 w-10 rounded-full flex items-center justify-center font-medium mr-3">
                            ${item.attendanceOrder || '-'}
                        </div>
                        <div>
                            <h3 class="font-medium text-gray-800">${item.name}</h3>
                            <p class="text-sm text-gray-500">${formattedDate} ${formattedTime}</p>
                        </div>
                    </div>
                    <button class="delete-btn ${isAdminMode ? '' : 'hidden'}" data-id="${item.id}">삭제</button>
                `;
                attendanceList.appendChild(card);
            });
        }

        function updateTotalCount() {
            totalCount.textContent = `총 ${attendanceData.length}명`;
        }

        function updateLastUpdateTime() {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            lastUpdateTime.textContent = `${hours}:${minutes}:${seconds}`;
        }

        function showFormAlert(message, type) {
            formAlert.textContent = message;
            formAlert.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800', 'bg-yellow-100', 'text-yellow-800');
            
            switch (type) {
                case 'success':
                    formAlert.classList.add('bg-green-100', 'text-green-800');
                    break;
                case 'error':
                    formAlert.classList.add('bg-red-100', 'text-red-800');
                    break;
                case 'warning':
                    formAlert.classList.add('bg-yellow-100', 'text-yellow-800');
                    break;
            }
            
            formAlert.classList.add('fade-in');
            formAlert.classList.remove('hidden');
            
            setTimeout(() => {
                formAlert.classList.add('hidden');
            }, 3000);
        }

        // 명단 관리 모달 알림
        function showRosterAlert(message, type) {
            rosterAlert.textContent = message;
            rosterAlert.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800', 'bg-yellow-100', 'text-yellow-800');
            
            switch (type) {
                case 'success':
                    rosterAlert.classList.add('bg-green-100', 'text-green-800');
                    break;
                case 'error':
                    rosterAlert.classList.add('bg-red-100', 'text-red-800');
                    break;
                case 'warning':
                    rosterAlert.classList.add('bg-yellow-100', 'text-yellow-800');
                    break;
            }
            
            rosterAlert.classList.add('fade-in');
            rosterAlert.classList.remove('hidden');
            
            setTimeout(() => {
                rosterAlert.classList.add('hidden');
            }, 3000);
        }

        function showAdminAlert(message, type) {
            adminAlert.textContent = message;
            adminAlert.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800', 'bg-yellow-100', 'text-yellow-800');
            
            switch (type) {
                case 'success':
                    adminAlert.classList.add('bg-green-100', 'text-green-800');
                    break;
                case 'error':
                    adminAlert.classList.add('bg-red-100', 'text-red-800');
                    break;
                case 'warning':
                    adminAlert.classList.add('bg-yellow-100', 'text-yellow-800');
                    break;
            }
            
            adminAlert.classList.add('fade-in');
            adminAlert.classList.remove('hidden');
            
            setTimeout(() => {
                adminAlert.classList.add('hidden');
            }, 3000);
        }

        function showStatus(message, type, autoHide = true) {
            statusBar.classList.remove('hidden');
            
            switch (type) {
                case 'success':
                    statusIcon.className = 'w-3 h-3 rounded-full mr-2 bg-green-500';
                    statusText.className = 'text-sm text-green-700';
                    break;
                case 'warning':
                    statusIcon.className = 'w-3 h-3 rounded-full mr-2 bg-yellow-500';
                    statusText.className = 'text-sm text-yellow-700';
                    break;
                case 'info':
                    statusIcon.className = 'w-3 h-3 rounded-full mr-2 bg-blue-500';
                    statusText.className = 'text-sm text-blue-700';
                    break;
                case 'error':
                    statusIcon.className = 'w-3 h-3 rounded-full mr-2 bg-red-500';
                    statusText.className = 'text-sm text-red-700';
                    break;
            }
            
            statusText.textContent = message;
            
            if (autoHide) {
                setTimeout(() => {
                    statusBar.classList.add('hidden');
                }, 3000);
            }
        }

        function showLoading(isLoading) {
            if (isLoading) {
                loadingIndicator.classList.remove('hidden');
            } else {
                loadingIndicator.classList.add('hidden');
            }
        }

        // --- 모달 공통 닫기 함수 ---
        function closeModal(modalElement, onClosedCallback = null) {
            modalElement.style.display = 'none';
            if (onClosedCallback) onClosedCallback();
        }

        // Admin modal event listeners
        adminBtn.addEventListener('click', () => {
            if (!isAuthReady) {
                showAdminAlert('시스템 준비 중입니다. 잠시 후 다시 시도해주세요.', 'info');
                return;
            }
            adminModal.style.display = 'flex';
            adminPassword.value = '';
            passwordSection.classList.remove('hidden');
            adminControlsSection.classList.add('hidden');
            adminAlert.classList.add('hidden');
            isAdminMode = false;
            renderAttendanceList(); // 관리자 모드 아님으로 표시
        });

        adminModalCloseBtn.addEventListener('click', () => closeModal(adminModal, () => {
            isAdminMode = false;
            renderAttendanceList();
        }));
        cancelAdminBtn.addEventListener('click', () => closeModal(adminModal, () => {
            isAdminMode = false;
            renderAttendanceList();
        }));
        closeAdminBtn.addEventListener('click', () => closeModal(adminModal, () => {
            isAdminMode = false;
            renderAttendanceList();
        }));

        verifyAdminBtn.addEventListener('click', () => {
            if (adminPassword.value === ADMIN_PASSWORD) {
                passwordSection.classList.add('hidden');
                adminControlsSection.classList.remove('hidden');
                showAdminAlert('관리자 인증 완료!', 'success');
                isAdminMode = true;
                renderAttendanceList(); // 관리자 모드 활성화로 다시 렌더링 (삭제 버튼 보이게)
            } else {
                adminPassword.classList.add('shake');
                setTimeout(() => adminPassword.classList.remove('shake'), 500);
                adminPassword.value = '';
                adminPassword.focus();
                showAdminAlert('비밀번호가 일치하지 않습니다.', 'error');
                isAdminMode = false;
                renderAttendanceList();
            }
        });

        resetAttendanceBtn.addEventListener('click', () => {
            showConfirmationModal('정말로 모든 출석 기록을 초기화하시겠습니까? 이 작업은 되돌릴 수 없습니다.', async (confirmed) => {
                if (confirmed) {
                    resetAttendanceBtn.disabled = true;
                    resetAttendanceBtn.innerHTML = '<div class="spinner mx-auto"></div>';
                    
                    console.log('출석 기록 초기화 요청');
                    showStatus('출석 기록 초기화 중...', 'info', false);

                    try {
                        const attendanceCollectionRef = collection(db, `artifacts/${appId}/public/data/attendance`);
                        const q = query(attendanceCollectionRef);
                        const querySnapshot = await getDocs(q);

                        if (!querySnapshot.empty) {
                            await runTransaction(db, async (transaction) => {
                                querySnapshot.forEach((doc) => {
                                    transaction.delete(doc.ref);
                                });
                            });
                        }
                        
                        showAdminAlert('모든 출석 기록이 초기화되었습니다.', 'success');
                        showStatus('모든 출석 기록 초기화 완료', 'success');
                        
                        setTimeout(() => {
                            closeModal(adminModal, () => {
                                isAdminMode = false;
                                renderAttendanceList();
                            });
                        }, 1000);

                    } catch (error) {
                        console.error("출석 초기화 오류:", error);
                        showAdminAlert('초기화 중 오류가 발생했습니다.', 'error');
                        showStatus('초기화 실패', 'error');
                    } finally {
                        resetAttendanceBtn.disabled = false;
                        resetAttendanceBtn.textContent = '모든 출석 기록 초기화';
                        statusBar.classList.add('hidden');
                    }
                } else {
                    console.log('초기화 취소됨');
                }
            });
        });

        async function deleteAttendanceEntry(docId) {
            showConfirmationModal('이 출석 기록을 정말로 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.', async (confirmed) => {
                if (confirmed) {
                    console.log('ID로 문서 삭제:', docId);
                    showStatus('출석 기록 삭제 중...', 'info', false);

                    try {
                        const attendanceDocRef = doc(db, `artifacts/${appId}/public/data/attendance`, docId);
                        await deleteDoc(attendanceDocRef);
                        showAdminAlert('출석 기록이 삭제되었습니다.', 'success');
                        showStatus('출석 기록 삭제 완료', 'success');
                    } catch (error) {
                        console.error("문서 삭제 오류:", error);
                        showAdminAlert('삭제 중 오류가 발생했습니다.', 'error');
                        showStatus('삭제 실패', 'error');
                    } finally {
                        statusBar.classList.add('hidden');
                    }
                } else {
                    console.log('삭제 취소됨.');
                }
            });
        }
        
        attendanceList.addEventListener('click', (e) => {
            if (e.target && e.target.classList.contains('delete-btn')) {
                const docId = e.target.dataset.id;
                if (docId && isAdminMode) {
                    deleteAttendanceEntry(docId);
                } else if (!isAdminMode) {
                    showAdminAlert('삭제하려면 관리자 인증이 필요합니다.', 'warning');
                }
            }
        });

        function showConfirmationModal(message, callback) {
            confirmationMessage.textContent = message;
            confirmationModal.style.display = 'flex';

            const handleConfirm = () => {
                closeModal(confirmationModal);
                callback(true);
            };

            const handleCancel = () => {
                closeModal(confirmationModal);
                callback(false);
            };

            confirmProceedBtn.addEventListener('click', handleConfirm, { once: true });
            confirmCancelBtn.addEventListener('click', handleCancel, { once: true });
            confirmModalCloseBtn.addEventListener('click', handleCancel, { once: true });

            confirmationModal.addEventListener('click', function(e) {
                if (e.target === confirmationModal) {
                    handleCancel();
                }
            }, { once: true });
        }

        adminPassword.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                verifyAdminBtn.click();
            }
        });
        
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                console.log('페이지 가시성 변경: 보임');
            }
        });


        // ===========================================
        // QR Code Generation Logic
        // ===========================================

        qrCodeBtn.addEventListener('click', () => {
            if (!isAuthReady) {
                showStatus('시스템 준비 중입니다. 잠시 후 다시 시도해주세요.', 'info');
                return;
            }
            const currentUrl = window.location.href;
            qrCodeUrlDisplay.textContent = currentUrl;

            // 기존 QR 코드가 있다면 지우고 새로 생성
            qrcodeContainer.innerHTML = ''; 

            new QRCode(qrcodeContainer, {
                text: currentUrl,
                width: 200,      
                height: 200,     
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });

            qrCodeModal.style.display = 'flex';
        });

        qrModalCloseBtn.addEventListener('click', () => {
            closeModal(qrCodeModal, () => qrcodeContainer.innerHTML = ''); // 모달 닫을 때 QR 코드 컨테이너 비우기
        });

        qrCodeModal.addEventListener('click', (e) => {
            if (e.target === qrCodeModal) {
                closeModal(qrCodeModal, () => qrcodeContainer.innerHTML = '');
            }
        });

        copyUrlBtn.addEventListener('click', () => {
            const urlToCopy = qrCodeUrlDisplay.textContent;
            const textarea = document.createElement('textarea');
            textarea.value = urlToCopy;
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                showStatus('URL이 클립보드에 복사되었습니다!', 'success');
            } catch (err) {
                showStatus('URL 복사에 실패했습니다. 직접 복사해주세요.', 'error');
                console.error('URL 복사 실패:', err);
            }
            document.body.removeChild(textarea);
        });

        // ===========================================
        // NEW: Roster Management Logic (명단 관리 로직)
        // ===========================================

        manageRosterBtn.addEventListener('click', async () => {
            if (!isAuthReady) {
                showRosterAlert('시스템 준비 중입니다. 잠시 후 다시 시도해주세요.', 'info');
                return;
            }
            rosterModal.style.display = 'flex'; // 명단 관리 모달 표시
            showRosterAlert('현재 명단을 불러오는 중입니다...', 'info');
            rosterInput.value = ''; // 입력창 초기화
            currentRosterDisplay.classList.add('hidden'); // 명단 표시 숨기기

            await fetchRosterToModal(); // 모달 열릴 때 명단 불러오기
            showRosterAlert('명단을 수정하거나 확인하세요.', 'info');
        });

        rosterModalCloseBtn.addEventListener('click', () => closeModal(rosterModal));

        rosterModal.addEventListener('click', (e) => {
            if (e.target === rosterModal) {
                closeModal(rosterModal);
            }
        });

        // 명단 저장 버튼 클릭 시
        saveRosterBtn.addEventListener('click', async () => {
            const namesText = rosterInput.value.trim();
            const namesArray = namesText.split('\n').map(name => name.trim()).filter(name => name.length > 0);

            if (namesArray.length === 0) {
                showRosterAlert('저장할 이름이 없습니다. 이름을 입력해주세요.', 'warning');
                return;
            }

            showRosterAlert('명단 저장 중...', 'info');
            saveRosterBtn.disabled = true;

            try {
                const rosterDocRef = doc(db, `artifacts/${appId}/public/data/rosters`, ROSTER_DOC_ID);
                await setDoc(rosterDocRef, { names: namesArray });
                currentRoster = namesArray; // 현재 명단 업데이트
                showRosterAlert('명단이 성공적으로 저장되었습니다!', 'success');
                showStatus('명단 저장 완료', 'success');
                // 저장 후 명단 표시
                await fetchRosterToModal();
            } catch (error) {
                console.error("명단 저장 오류:", error);
                showRosterAlert('명단 저장 중 오류가 발생했습니다.', 'error');
                showStatus('명단 저장 실패', 'error');
            } finally {
                saveRosterBtn.disabled = false;
            }
        });

        // 현재 명단 확인 버튼 클릭 시
        viewCurrentRosterBtn.addEventListener('click', async () => {
            await fetchRosterToModal(); // 명단 다시 불러와서 표시
            currentRosterDisplay.classList.remove('hidden'); // 명단 표시 영역 보이게
            showRosterAlert('현재 저장된 명단입니다.', 'info');
        });

        // 명단 모달에서 명단을 불러와 표시하는 함수
        async function fetchRosterToModal() {
            currentRosterList.innerHTML = ''; // 기존 목록 지우기
            emptyRosterMessage.classList.add('hidden'); // '저장된 명단 없음' 메시지 숨기기
            currentRosterDisplay.classList.add('hidden'); // 일단 숨겨둠

            await fetchRoster(); // 최신 명단 불러오기 (currentRoster 업데이트됨)

            if (currentRoster.length > 0) {
                currentRoster.forEach(name => {
                    const li = document.createElement('li');
                    li.textContent = name;
                    currentRosterList.appendChild(li);
                });
                currentRosterDisplay.classList.remove('hidden'); // 명단 표시 영역 보이게
            } else {
                emptyRosterMessage.classList.remove('hidden'); // '저장된 명단 없음' 메시지 보이게
                currentRosterDisplay.classList.remove('hidden'); // 영역은 보이게
            }
            rosterInput.value = currentRoster.join('\n'); // 입력창에도 현재 명단 넣어주기
        }

        // ===========================================
        // NEW: Export Attendance to CSV Logic (출석 명단 CSV 다운로드 로직)
        // ===========================================
        exportCsvBtn.addEventListener('click', () => {
            if (!isAdminMode) {
                showAdminAlert('CSV 다운로드는 관리자만 가능합니다.', 'warning');
                return;
            }
            if (!attendanceData || attendanceData.length === 0) {
                showAdminAlert('다운로드할 출석 기록이 없습니다.', 'warning');
                return;
            }

            // CSV 헤더 (컬럼 이름)
            const headers = [
                "출석번호",
                "이름",
                "출석시간",
                "사용자ID"
            ];

            // CSV 데이터 행 생성
            const csvRows = attendanceData.map(item => {
                const date = item.timestamp && typeof item.timestamp.toDate === 'function' ? item.timestamp.toDate() : null;
                const formattedTime = date ? `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}:${date.getSeconds().toString().padStart(2, '0')}` : '시간 정보 없음';

                // CSV 형식에 맞게 데이터를 배열로 만들고, 쉼표나 따옴표가 포함될 수 있는 필드는 큰따옴표로 묶습니다.
                return [
                    item.attendanceOrder || '',
                    `"${(item.name || '').replace(/"/g, '""')}"`, // 이름에 쉼표나 따옴표가 있을 경우 대비
                    `"${formattedTime}"`,
                    `"${item.userId || ''}"`
                ].join(','); // 쉼표로 각 컬럼 구분
            });

            // 헤더와 데이터 행을 합치고 각 행은 줄바꿈으로 구분
            const csvContent = [headers.join(','), ...csvRows].join('\n');

            // Blob 객체 생성 (텍스트 데이터를 파일처럼 다루기 위함)
            // '\ufeff'는 BOM(Byte Order Mark)으로, 엑셀에서 한글 깨짐 방지용
            const blob = new Blob(['\ufeff', csvContent], { type: 'text/csv;charset=utf-8;' }); 

            // 다운로드 링크 생성 및 클릭
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `출석명단_${new Date().toISOString().slice(0,10).replace(/-/g, '')}.csv`; // 파일 이름 (예: 출석명단_20250728.csv)
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url); // 메모리 해제

            showAdminAlert('출석 명단 CSV 파일이 다운로드되었습니다.', 'success');
            showStatus('CSV 다운로드 완료!', 'success');
        });

    </script>
</body>
</html>
